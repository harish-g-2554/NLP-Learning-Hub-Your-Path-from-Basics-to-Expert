<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Module 3 — Edit Distance & Applications</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<head>
  <!-- ... your other head elements ... -->
  <style>
    .page-nav {
      padding: 12px 24px;
      background: rgba(17, 18, 28, 0.4);
      border-bottom: 1px solid #273041;
      margin-bottom: 24px;
    }
    .page-nav a {
      color: #cbd5ff;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .page-nav a:hover {
      text-decoration: underline;
    }
    /* ... rest of your styles ... */
  </style>
</head>
<body>
  <div class="scene">
    <header class="page-nav">
      <a href="{{ url_for('journey') }}">&larr; Back to All Modules</a>
    </header>
  <style>
    /* Re-using styles from other modules for consistency */
    .lesson-wrap{max-width:1200px;margin:0 auto;padding:8px 16px 96px}
    .modules-hero{max-width:960px;margin:0 auto 18px;text-align:center}
    .modules-title{font-size:clamp(1.8rem,4.8vw,3rem);margin:8px 0 6px}
    .modules-hero p{color:#9fb0d8}

    .term{margin:18px 0;padding:22px;border-radius:16px;background:linear-gradient(180deg,rgba(17,18,28,.75),rgba(17,18,28,.45));border:1px solid #273041;box-shadow:0 10px 30px #0003,0 0 0 1px #1f2333 inset}
    .term h2{margin:0 0 8px;color:#e6e8ff}
    .t-desc{color:#9aa6d1; line-height: 1.6;}
    .twocol{display:grid;grid-template-columns:1.1fr 1fr;gap:24px;margin-top:10px}
    @media (max-width:900px){.twocol{grid-template-columns:1fr}}

    .diagram{padding:12px;border:1px solid #2b3449;border-radius:12px;background:rgba(12,14,22,.45);margin:10px 0}
    .d-caption{font-size:.82rem;color:#91a0c7;margin-bottom:6px;font-weight:700}
    .txt{width:100%;border-radius:12px;border:1px solid #2b3449;background:#0f1220;color:#e8ebff;padding:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .infobox{background:linear-gradient(180deg,rgba(6,182,212,.08),rgba(124,58,237,.08));border:1px solid #334155;border-radius:12px;padding:10px 12px;color:#bdd3f4}

    /* DP Matrix Table Styles */
    .dp-matrix table { border-collapse: collapse; margin-top: 10px; }
    .dp-matrix th, .dp-matrix td {
        border: 1px solid #334155;
        width: 35px;
        height: 35px;
        text-align: center;
        font-family: var(--font-mono);
        position: relative;
    }
    .dp-matrix th { color: #a7b6e0; background: #1a1f33; }
    .dp-matrix td { color: #e0e6ff; }
    .dp-matrix .path { background-color: rgba(124, 58, 237, 0.25); }
    
    /* Aligned Output Styles */
    .aligned-output { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space: pre; font-size: 1.1rem; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="scene">
    <header class="modules-hero">
      <h1 class="modules-title">Module 3: <span>Edit Distance & Applications</span></h1>
      <p class="modules-sub">Measure how different two strings are, and discover how this simple idea powers spell checkers, DNA analysis, and more.</p>
    </header>

    <main class="lesson-wrap">

      <!-- WHAT IS EDIT DISTANCE -->
      <section class="term" id="intro">
        <h2>What is Edit Distance?</h2>
        <div class="twocol">
          <div>
            <p class="t-desc">
              <strong>Edit Distance</strong> is a way of measuring how dissimilar two strings are. It's defined as the minimum number of single-character edits—<strong>insertions</strong>, <strong>deletions</strong>, or <strong>substitutions</strong>—required to change one string into the other.
              <br><br>
              The most common type is the <strong>Levenshtein distance</strong>, which is what we'll focus on.
            </p>
            <div class="infobox">
              <strong>Analogy:</strong> Imagine you have the word "cat" and you want to turn it into "car". You only need to change one letter ('t' to 'r'). So, the edit distance between "cat" and "car" is 1.
            </div>
          </div>
          <div>
            <div class="diagram">
              <div class="d-caption">Core Applications</div>
              <ul>
                <li><strong>Spell Checkers:</strong> If you type "ocurrance", a spell checker sees it has a small edit distance to "occurrence" and suggests it as a correction.</li>
                <li><strong>Text Similarity:</strong> Helps find duplicate or near-duplicate documents by checking if their edit distance is very low.</li>
                <li><strong>Bioinformatics:</strong> Used to compare DNA and protein sequences to find similarities and evolutionary relationships. This is called <strong>Sequence Alignment</strong>.</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- HOW TO CALCULATE IT -->
      <section class="term" id="calculation">
        <h2>How is Edit Distance Calculated? The Magic of Dynamic Programming</h2>
        <p class="t-desc">
          Calculating the minimum number of edits sounds complicated. How do we know we found the *minimum*? We use a clever technique called <strong>Dynamic Programming</strong>. Instead of solving the whole problem at once, we build a grid (or matrix) and solve tiny sub-problems, using those solutions to solve bigger ones until we have our final answer.
        </p>
        <p class="t-desc">
          <strong>Step-by-step process for "saturday" to "sunday":</strong>
        </p>
        <ol>
          <li><strong>Create a Grid:</strong> Make a grid where the rows correspond to the characters of the source word (plus an empty start) and columns for the target word.</li>
          <li><strong>Initialize:</strong> Fill the first row and column with the number of insertions/deletions needed to form the prefixes. To get from "" to "sun", you need 3 insertions (0, 1, 2, 3).</li>
          <li><strong>Fill the Grid:</strong> For each cell `(i, j)`, calculate the cost to transform the first `i` characters of the source to the first `j` characters of the target. You take the minimum of three choices:
            <ul>
              <li><strong>Cost from above (Deletion):</strong> `grid[i-1][j] + 1`</li>
              <li><strong>Cost from left (Insertion):</strong> `grid[i][j-1] + 1`</li>
              <li><strong>Cost from diagonal (Substitution/Match):</strong> `grid[i-1][j-1] + cost`, where `cost` is 0 if the characters match, and 1 if they don't.</li>
            </ul>
          </li>
          <li><strong>Final Answer:</strong> The number in the bottom-right cell of the grid is the final Levenshtein distance.</li>
        </ol>
      </section>

      <!-- INTERACTIVE EDIT DISTANCE LAB -->
      <section class="term" id="lab-edit-distance">
        <h2>Lab: Visualizing Edit Distance</h2>
        <p class="t-desc">Enter two words below to see the DP matrix and the full alignment process.</p>
        <div class="diagram">
            <div class="twocol">
                <div>
                    <label for="wordA" class="lbl">Word A (Source)</label>
                    <input id="wordA" class="txt mono" value="saturday">
                </div>
                <div>
                    <label for="wordB" class="lbl">Word B (Target)</label>
                    <input id="wordB" class="txt mono" value="sunday">
                </div>
            </div>
            <div style="margin-top:10px">
                <button class="btn primary" id="btnCalculateDistance" type="button">Calculate</button>
            </div>
        </div>
        <div id="distance-results" style="display:none;">
            <div class="twocol">
                <div>
                    <h3>Dynamic Programming Matrix</h3>
                    <div id="dpMatrixContainer" class="dp-matrix" style="overflow-x:auto;"></div>
                </div>
                <div>
                    <h3>Report</h3>
                    <div id="distanceReport"></div>
                    <h3>Operations Trace</h3>
                    <div id="operationsTrace"></div>
                </div>
            </div>
            <div class="diagram">
                <div class="d-caption">Final Alignment</div>
                <div id="alignedWords" class="aligned-output"></div>
            </div>
        </div>
      </section>

      <!-- SEQUENCE ALIGNMENT -->
      <section class="term" id="sec-alignment">
        <h2>What is Sequence Alignment?</h2>
        <p class="t-desc">
          <strong>Sequence Alignment</strong> is a fundamental concept in bioinformatics, but it's really just a more general version of edit distance. Instead of just counting edits, we try to find the best way to line up two sequences (like DNA or proteins) to highlight regions of similarity. This is done by introducing gaps (represented by `-`) into the sequences.
        </p>
        <p class="t-desc">
          It's used to infer evolutionary relationships (if two species have very similar DNA for a certain gene, they are likely related), find important functional regions in genes, and assemble DNA fragments. The most famous algorithm for this is the <strong>Needleman-Wunsch algorithm</strong>, which also uses dynamic programming.
        </p>
      </section>

      <!-- INTERACTIVE SEQUENCE ALIGNMENT LAB -->
      <section class="term" id="lab-sequence-alignment">
        <h2>Lab: Sequence Alignment</h2>
        <p class="t-desc">Enter two sequences (typically DNA: A, C, G, T) to see the optimal global alignment.</p>
        <div class="diagram">
            <div>
                <label for="seqA" class="lbl">Sequence A</label>
                <textarea id="seqA" class="txt mono" rows="3">AGGCTATCACCTGACCTCCAGGCCGATGCCC</textarea>
            </div>
            <div style="margin-top:1rem;">
                <label for="seqB" class="lbl">Sequence B</label>
                <textarea id="seqB" class="txt mono" rows="3">TAGCTATCACGACCGCGGTCGATTTGCCCGAC</textarea>
            </div>
            <div style="margin-top:10px">
                <button class="btn primary" id="btnAlignSequences" type="button">Align</button>
            </div>
        </div>
        <div id="alignment-results" style="display:none;">
             <div class="diagram">
                <div class="d-caption">Aligned Sequences</div>
                <div id="alignedSequencesOutput" class="aligned-output"></div>
            </div>
        </div>
      </section>

      <!-- QUIZ -->
      <section class="term">
        <h2>Quick Quiz (10 Questions)</h2>
        <details class="qa"><summary><span class="qnum">1.</span> What are the three basic operations in Levenshtein distance?</summary><div class="answer">Insertion, Deletion, and Substitution.</div></details>
        <details class="qa"><summary><span class="qnum">2.</span> If the edit distance between two words is 0, what does that mean?</summary><div class="answer">The words are identical.</div></details>
        <details class="qa"><summary><span class="qnum">3.</span> What algorithm is commonly used to efficiently calculate edit distance?</summary><div class="answer">Dynamic Programming.</div></details>
        <details class="qa"><summary><span class="qnum">4.</span> In the DP matrix for edit distance, what does the number in cell `(i, j)` represent?</summary><div class="answer">The minimum edit distance between the first `i` characters of the source word and the first `j` characters of the target word.</div></details>
        <details class="qa"><summary><span class="qnum">5.</span> What is a primary application of edit distance in everyday software?</summary><div class="answer">Spell checkers in word processors and search engines.</div></details>
        <details class="qa"><summary><span class="qnum">6.</span> What is the main goal of sequence alignment in bioinformatics?</summary><div class="answer">To identify regions of similarity between DNA, RNA, or protein sequences, which can indicate functional, structural, or evolutionary relationships.</div></details>
        <details class="qa"><summary><span class="qnum">7.</span> What does a gap (`-`) in an aligned sequence represent?</summary><div class="answer">An insertion or a deletion event.</div></details>
        <details class="qa"><summary><span class="qnum">8.</span> If two characters at the same position in an alignment are different, what kind of edit operation does this correspond to?</summary><div class="answer">A substitution.</div></details>
        <details class="qa"><summary><span class="qnum">9.</span> Why is dynamic programming better than checking every possible combination of edits?</summary><div class="answer">It's much more efficient because it solves small subproblems once and reuses their results, avoiding redundant calculations.</div></details>
        <details class="qa"><summary><span class="qnum">10.</span> What is the edit distance between "cat" and "cats"?</summary><div class="answer">1 (one insertion of 's').</div></details>
      </section>

    </main>
  </div>

  <script>
    // ---- API Helper ----
    async function postJSON(url, payload) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const errData = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
        throw new Error(errData.error);
      }
      return res.json();
    }

    // ---- Edit Distance Lab ----
    const wordAInput = document.getElementById('wordA');
    const wordBInput = document.getElementById('wordB');
    const calculateBtn = document.getElementById('btnCalculateDistance');
    const distanceResultsDiv = document.getElementById('distance-results');
    const dpMatrixContainer = document.getElementById('dpMatrixContainer');
    const distanceReportDiv = document.getElementById('distanceReport');
    const operationsTraceDiv = document.getElementById('operationsTrace');
    const alignedWordsDiv = document.getElementById('alignedWords');

    calculateBtn.addEventListener('click', async () => {
        const word1 = wordAInput.value;
        const word2 = wordBInput.value;
        if (!word1 || !word2) {
            alert('Please enter both words.');
            return;
        }

        try {
            const data = await postJSON('/api/edit-distance/calculate', { word1, word2 });
            renderDistanceResults(data, word1, word2);
            distanceResultsDiv.style.display = 'block';
        } catch (e) {
            alert(`Error: ${e.message}`);
        }
    });

    function renderDistanceResults(data, word1, word2) {
        // Render DP Matrix
        let tableHtml = '<table><thead><tr><th></th><th>#</th>';
        for (let char of word2) {
            tableHtml += `<th>${char}</th>`;
        }
        tableHtml += '</tr></thead><tbody>';
        for (let i = 0; i < data.dp_matrix.length; i++) {
            tableHtml += `<tr><th>${i === 0 ? '#' : word1[i-1]}</th>`;
            for (let j = 0; j < data.dp_matrix[i].length; j++) {
                const isPath = data.path.some(p => p[0] === i && p[1] === j);
                tableHtml += `<td class="${isPath ? 'path' : ''}">${data.dp_matrix[i][j]}</td>`;
            }
            tableHtml += '</tr>';
        }
        tableHtml += '</tbody></table>';
        dpMatrixContainer.innerHTML = tableHtml;

        // Render Report
        distanceReportDiv.innerHTML = `
            <p><strong>Total Minimum Edit Distance:</strong> ${data.distance}</p>
            <ul>
                <li><strong>Matches:</strong> ${data.matches}</li>
                <li><strong>Substitutions:</strong> ${data.substitutions}</li>
                <li><strong>Insertions:</strong> ${data.insertions}</li>
                <li><strong>Deletions:</strong> ${data.deletions}</li>
            </ul>
        `;

        // Render Operations
        operationsTraceDiv.innerHTML = data.operations.map(op => `<p>${op}</p>`).join('');

        // Render Aligned Words
        alignedWordsDiv.innerText = `${data.aligned_word1}\n${data.aligned_word2}`;
    }

    // ---- Sequence Alignment Lab ----
    const seqAInput = document.getElementById('seqA');
    const seqBInput = document.getElementById('seqB');
    const alignBtn = document.getElementById('btnAlignSequences');
    const alignmentResultsDiv = document.getElementById('alignment-results');
    const alignedSequencesOutputDiv = document.getElementById('alignedSequencesOutput');

    alignBtn.addEventListener('click', async () => {
        const seq1 = seqAInput.value;
        const seq2 = seqBInput.value;
        if (!seq1 || !seq2) {
            alert('Please enter both sequences.');
            return;
        }

        try {
            const data = await postJSON('/api/sequence-alignment/align', { seq1, seq2 });
            // FIX: Correctly display the alignment, comparison string, and score
            alignedSequencesOutputDiv.innerText = `${data.aligned_seq1}\n${data.comparison}\n${data.aligned_seq2}\n\nScore: ${data.score}`;
            alignmentResultsDiv.style.display = 'block';
        } catch (e) {
            alert(`Error: ${e.message}`);
        }
    });

  </script>
</body>
</html>
